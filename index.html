<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TerraLIVE</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.12/esri/themes/light/main.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include Chart.js -->
  <style>
    /* Flexbox container for aligning text and charts */
    .info-container {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    /* Chart container with consistent sizing */
    .chart-container {
      width: 100px;
      height: 100px;
      margin-left: 20px;
    }

    /* Text container to separate from chart */
    .text-container {
      flex: 1;
    }

    /* Ensure the charts are not scaled improperly */
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>

  <header class="title">
    <h2>TerraLIVE</h2>
    <p>Your window to the world</p>
  </header>

  <section class="main-content">
    <div id="viewDiv"></div>
    <div id="info" class="info-panel">
      
      <h3>Current Gas Levels</h3>
      <div class="info-container gas-info" 
           data-co2="{{ gas_levels.CO2|replace(' ppm', '') }}" 
           data-o2="{{ gas_levels.O2|replace('%', '') }}" 
           data-n="{{ gas_levels.N|replace('%', '') }}">
        <div class="text-container">
          <p>CO2: {{ gas_levels.CO2 }}</p>
          <p>O2: {{ gas_levels.O2 }}</p>
          <p>N: {{ gas_levels.N }}</p>
        </div>
        <div class="chart-container">
          <canvas id="gasChart"></canvas> <!-- Mini Pie Chart for Gas Levels -->
        </div>
      </div>

      <h3>Current Air Quality</h3>
      <div class="info-container air-info" 
           data-aqi="{{ air_quality.AQI }}" 
           data-pm25="{{ air_quality.PM2_5|replace(' µg/m³', '') }}" 
           data-pm10="{{ air_quality.PM10|replace(' µg/m³', '') }}" 
           data-ozone="{{ air_quality.Ozone|replace(' ppb', '') }}">
        <div class="text-container">
          <p>AQI: {{ air_quality.AQI }}</p>
          <p>PM2.5: {{ air_quality.PM2_5 }}</p>
          <p>PM10: {{ air_quality.PM10 }}</p>
          <p>Ozone: {{ air_quality.Ozone }}</p>
        </div>
        <div class="chart-container">
          <canvas id="airChart"></canvas> <!-- Mini Pie Chart for Air Quality -->
        </div>
      </div>
      
    </div>
  </section>

  <script src="https://js.arcgis.com/4.12/"></script>
  <script>
    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/TileLayer",
      "esri/layers/GeoJSONLayer",
      "esri/Basemap"
    ], function (Map, SceneView, TileLayer, GeoJSONLayer, Basemap) {

      const basemap = new Basemap({
        baseLayers: [
          new TileLayer({
            url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer"
          })
        ]
      });

      const map = new Map({
        basemap: basemap
      });

      const view = new SceneView({
        container: "viewDiv",
        map: map,
        alphaCompositingEnabled: true,
        qualityProfile: "high",
        camera: {
          position: [20, 22, 40000000],
          fov: 40,
        },
        environment: {
          background: {
            type: "color",
            color: [255, 255, 255, 0]
          },
          starsEnabled: false,
          atmosphereEnabled: false,
          lighting: {
            directShadowsEnabled: false,
          }
        },
        constraints: {
          altitude: {
            min: 2000000,
            max: 40000000
          }
        },
        popup: {
          dockEnabled: true,
          dockOptions: {
              position: "top-right",
              breakpoint: false,
              buttonEnabled: false
          },
          collapseEnabled: false
        },
        highlightOptions: {
          color: [0, 255, 255],
          haloOpacity: 0.5
        }
      });

      view.ui.empty("top-left");

      const extremesLayer = new GeoJSONLayer({
        url: "{{ url_for('static', filename='states.geojson') }}",
        elevationInfo: {
          mode: "absolute-height",
          offset: 300000,
        },
        renderer: {
          type: "simple",
          symbol: {
            type: "point-3d",
            symbolLayers: [
              {
                type: "icon",
                resource: { href: "{{ url_for('static', filename='dot-circle-regular.svg') }}" },
                size: 10,
                material: { color: "red" }
              },
            ],
          },
        },
        popupTemplate: {
          title: "{state}",
          content: `
            <b>Real-Time Weather:</b><br/>
            <b>Temperature:</b> {real_time_temperature}<br/>
            <b>Condition:</b> {real_time_condition}<br/>
            <b>Duration:</b> {real_time_duration}<br/>
            <b>Humidity:</b> {real_time_humidity}<br/><br/>
            <b>Predicted Weather:</b><br/>
            <b>Temperature:</b> {predicted_temperature}<br/>
            <b>Condition:</b> {predicted_condition}<br/>
            <b>Duration:</b> {predicted_duration}<br/>
            <b>Humidity:</b> {predicted_humidity}
          `
        },
      });

      map.layers.add(extremesLayer);

      let rotating = true; // Control rotation
      let interactionTimeout; // For tracking interaction timeout

      // Function to rotate the 3D Earth
      function rotateEarth() {
        let angle = 0;

        function updateRotation() {
          if (rotating) { // Only rotate if not interacting
            angle += 0.2; // Adjust this value for faster or slower rotation

            view.goTo({
              position: {
                x: angle, // Longitude changes to simulate rotation
                y: 22,    // Latitude remains constant
                z: 40000000  // Altitude remains constant
              }
            }, {animate: false});
          }

          requestAnimationFrame(updateRotation); // Continue the rotation
        }

        updateRotation(); // Start the rotation
      }

      rotateEarth(); // Call the function to rotate the Earth

      // Stop rotation on user interaction and restart after 5 seconds of inactivity
      function resetRotationTimeout() {
        clearTimeout(interactionTimeout); // Clear any existing timeout
        rotating = false; // Stop rotation during interaction
        interactionTimeout = setTimeout(() => {
          rotating = true; // Resume rotation after 5 seconds
        }, 5000); // 5 seconds
      }

      // Improved event listeners to detect interaction
      view.on("drag", resetRotationTimeout); // Stops rotation on dragging
      view.on("click", resetRotationTimeout); // Stops rotation on clicking
      view.on("pointerdown", resetRotationTimeout); // Stops rotation on pointer down

      // Additionally, reset the timeout on pointer move to catch all interactions
      view.on("pointermove", resetRotationTimeout);
    });

    // JavaScript for rendering Pie Charts using Chart.js
    window.onload = function() {
      // Get data attributes
      var gasInfoDiv = document.querySelector('.gas-info');
      var airInfoDiv = document.querySelector('.air-info');

      var gasData = {
        labels: ["CO2", "O2", "N"],
        datasets: [{
          data: [
            gasInfoDiv.getAttribute('data-co2'),
            gasInfoDiv.getAttribute('data-o2'),
            gasInfoDiv.getAttribute('data-n')
          ],
          backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56"]
        }]
      };

      var airData = {
        labels: ["AQI", "PM2.5", "PM10", "Ozone"],
        datasets: [{
          data: [
            airInfoDiv.getAttribute('data-aqi'),
            airInfoDiv.getAttribute('data-pm25'),
            airInfoDiv.getAttribute('data-pm10'),
            airInfoDiv.getAttribute('data-ozone')
          ],
          backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0"]
        }]
      };

      var gasCtx = document.getElementById('gasChart').getContext('2d');
      var airCtx = document.getElementById('airChart').getContext('2d');

      new Chart(gasCtx, {
        type: 'pie',
        data: gasData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: false
          }
        }
      });

      new Chart(airCtx, {
        type: 'pie',
        data: airData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: false
          }
        }
      });
    };
  </script>  
</body>
</html>
